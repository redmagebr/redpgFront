function PictureUI(){this.$window=$("#pictureWindow").hide();this.$element=$("#pictureElement").hide();this.$loading=$("#pictureLoading");this.$currentSize=$('<a class="paintIconSmall language button" data-langtitle="_DRAWINGSIZE_" />').on("click",function(){window.app.ui.pictureui.changeSize()});this.$currentColor=$('<a class="language button" data-langtitle="_DRAWINGCOLOR_" style="background-color: #CC0000" />').append("<a></a>");this.$eraser=$('<a class="language button paintIconEraser" data-langtitle="_DRAWINGERASER_" />').on("click",function(){window.app.ui.pictureui.color="none";window.app.ui.pictureui.size=10;window.app.ui.pictureui.$currentColor.css("background-color","transparent")});this.$clear=$('<a class="paintIconClear language button" data-langtitle="_DRAWINGCLEAR_" style="background-color: #ffffff" />').on("click",function(){window.app.ui.pictureui.sendClear()});this.$lock=$('<a class="paintIconLock language button" data-langtitle="_DRAWINGLOCK_" />').on("click",function(){var a=new Message();a.module="pica";a.setSpecial("lock",!window.app.ui.pictureui.isLocked());a.msg="lock";window.app.chatapp.fixPrintAndSend(a,true)});this.$paintingTools=$("#picturePaint").append(this.$currentSize).append(this.$currentColor).append(this.$clear).append(this.$eraser).append(this.$lock);this.locked={};this.color="#CC0000";this.size=1;this.drawings={};this.myArt={};this.$canvas=null;this.touchTimeout=null;this.$currentColor.colpick({flat:true,layout:"hex",submit:1,color:"CC0000",onSubmit:function(a,e,c,d,b){$(d).css("background-color","#"+e).children("div").stop(true,false).fadeOut(200);window.app.ui.pictureui.color="#"+e}}).children("div").hide();this.$currentColor.children("a").on("click",function(){$(this).parent().children("div").stop(true,false).fadeIn(200)});this.link404="img/404.png";this.$close=$("#pictureWindowClose").on("click",function(){window.app.ui.pictureui.close()});this.$element.on("load",function(){window.app.ui.pictureui.updatePicture()});this.stream=false;this.handleResize=function(){if(window.app.ui.chat.mc.getModule("stream")===null||!window.app.ui.chat.mc.getModule("stream").isStream){this.$window.css({width:window.app.ui.$rightWindow.width()})}else{this.$window.css("width","")}this.updatePicture()};this.fullscreen=function(b){var a=b?100:10;if(window.app.ui.chat.mc.getModule("stream")===null||!window.app.ui.chat.mc.getModule("stream").isStream){this.$window.css("right",a+"px")}else{this.$window.css("right","")}this.updatePicture()};this.open=function(a){try{a=decodeURIComponent(a)}catch(c){}if(a.indexOf("dropbox.com")!==-1){a=a.replace("dl=0","dl=1");if(a.indexOf("dl=1")===-1){a=a+(a.indexOf("?")!==-1?"":"?")+"dl=1"}}var b=this.$element.attr("src");this.$element.off("error").on("error",function(){window.app.ui.pictureui.invalidPicture()}).attr("src",a).css({width:0,height:0});this.$window.stop(true,false).fadeIn(200);this.$loading.stop(true,true).show();this.$paintingTools.stop(true,false).hide();if(window.app.ui.pictureui.$canvas!==null){window.app.ui.pictureui.$canvas.remove();window.app.ui.pictureui.$canvas=null}if(b===a){this.$element.trigger("load")}};this.updatePicture=function(){if(this.$element.attr("src")===undefined){return}this.$element.css("width","").css("height","");this.$loading.stop(true,false).fadeOut(200);var a=this.$element[0].naturalHeight;var j=this.$element[0].naturalWidth;if(a===0||j===0){return}var c=this.stream?0:40;var g=this.$window.height()-c;var h=this.$window.width()-c;var i=h/j;var d=g/a;if(this.stream){var e=i<d?d:i}else{var e=i<d?i:d}var f=(this.$window.height()-(a*e))/2;if(!this.stream&&f<30&&this.$element.attr("src")!==this.link404){f=30}var b=(this.$window.width()-(j*e))/2;this.$element.css({width:j*e,height:a*e,top:f,left:b});this.$element.show();this.src=this.$element.attr("src");if(this.$element.attr("src")!==this.link404){this.showPainting();this.updateCanvas(true)}};this.addDrawings=function(c,f){var d=window.app.chatapp.room!==null?window.app.chatapp.room.id:"0";d=d+c;if(this.drawings[d]===undefined){var a=window.app.memory.getMemory("draw"+d,null);if(a!==null){try{this.drawings[d]=JSON.parse(a)}catch(b){this.drawings[d]=[]}}else{this.drawings[d]=[]}}this.drawings[d]=this.drawings[d].concat(f);window.app.memory.setMemory("draw"+d,JSON.stringify(this.drawings[d]));if(c===this.src){this.updateCanvas()}};this.clearDrawings=function(a){var b=window.app.chatapp.room!==null?window.app.chatapp.room.id:"0";b=b+a;this.drawings[b]=[];window.app.memory.setMemory("draw"+b,JSON.stringify(this.drawings[b]));if(a===this.src){this.updateCanvas()}};this.sendClear=function(){var a=new Message();a.module="pica";a.setSpecial("clear",true);a.msg=this.src;window.app.chatapp.fixPrintAndSend(a,false)};this.showPainting=function(){this.$paintingTools.stop(true,false).unhide()};this.updateCanvas=function(b){if(window.app.chatapp.room===null){this.$paintingTools.hide()}else{if(!window.app.chatapp.room.getMe().isStoryteller()){this.$lock.detach();this.$clear.detach();this.$paintingTools.unhide()}else{this.$paintingTools.append(this.$clear).append(this.$lock);if(this.isLocked()){this.$lock.addClass("toggled")}else{this.$lock.removeClass("toggled")}this.$paintingTools.unhide()}}if(this.$canvas===null){b=true;var a=this.$element[0].naturalWidth;var c=this.$element[0].naturalHeight;this.$canvas=$('<canvas id="pictureCanvas" width="'+a+'" height="'+c+'" />');this.$window.append(this.$canvas);this.canvasContext=this.$canvas[0].getContext("2d");this.$canvas.on("mousedown",function(f){window.app.ui.pictureui.mousedown(f);$(window).on("mouseup.canvasDrawing",function(g){$(this).off("mouseup.canvasDrawing");window.app.ui.pictureui.mouseup(g)})}).on("mousemove",function(f){window.app.ui.pictureui.mousemove(f)}).on("mouseup",function(f){window.app.ui.pictureui.mouseup(f);$(window).off("mouseup.canvasDrawing")}).on("touchstart",function(f){window.app.ui.pictureui.touchstart(f)}).on("touchmove",function(f){window.app.ui.pictureui.touchmove(f)}).on("touchend touchcancel",function(f){window.app.ui.pictureui.touchcancel(f)});this.oWidth=a;this.oHeight=c}if(b){this.$canvas.css({top:this.$element.css("top"),left:this.$element.css("left"),height:this.$element.css("height"),width:this.$element.css("width")});this.width=this.$canvas.width();this.height=this.$canvas.height();this.offset=this.$canvas.offset()}var d=window.app.chatapp.room!==null?window.app.chatapp.room.id:"0";d=d+this.src;if(this.drawings[d]===undefined){this.addDrawings(this.src,[])}this.canvasContext.clearRect(0,0,this.canvasContext.canvas.width,this.canvasContext.canvas.height);if(this.src.toUpperCase().indexOf(".GIF")===-1){this.canvasContext.drawImage(this.$element[0],0,0)}this.canvasContext.beginPath();this.drawArray(this.drawings[d]);if(this.myArt[d]!==undefined){this.drawArray(this.myArt[d])}this.canvasContext.stroke();this.canvasContext.closePath()};this.drawArray=function(c){for(var b=0;b<c.length;b++){var a=c[b];if(a.length>=4){if(a.length===4||a[4]===1){this.canvasContext.stroke();this.canvasContext.closePath();this.canvasContext.beginPath();this.canvasContext.lineWidth=2;this.canvasContext.lineCap="round";this.canvasContext.moveTo(a[0],a[1])}if(!isNaN(a[2],10)){this.canvasContext.lineWidth=parseInt(a[2])}if(a[3].indexOf("#")!==-1){this.canvasContext.globalCompositeOperation="source-over";this.canvasContext.strokeStyle=a[3]}else{this.canvasContext.globalCompositeOperation="destination-out"}if(a.length===3||a[3]===1){continue}}this.canvasContext.lineTo(a[0],a[1]);this.canvasContext.moveTo(a[0],a[1])}};this.touchtomouse=function(a){var b=a.originalEvent.touches[0]||a.originalEvent.changedTouches[0];return b};this.touchstart=function(a){a.preventDefault();this.mousedown(this.touchtomouse(a))};this.touchmove=function(a){a.preventDefault();if(this.touchTimeout!==null){window.clearTimeout(this.touchTimeout)}this.touchTimeout=window.setTimeout(200,function(){window.app.ui.pictureui.touchTimeout=null;window.app.ui.pictureui.mouseup()});this.mousemove(this.touchtomouse(a))};this.touchcancel=function(a){a.preventDefault();this.mouseup()};this.mousedown=function(a){this.painting=true;var b=window.app.chatapp.room!==null?window.app.chatapp.room.id:"0";b=b+this.src;this.myArt[b]=[];if(this.isLocked()){if(!window.app.chatapp.room.getMe().isStoryteller()){this.painting=false}}this.mousemove(a,1)};this.mouseup=function(){this.painting=false;if(this.touchTimeout!==null){window.clearTimeout(this.touchTimeout);this.touchTimeout=null}var b=window.app.chatapp.room!==null?window.app.chatapp.room.id:"0";b=b+this.src;if(this.myArt[b].length===0){return}this.drawings[b]=this.drawings[b].concat(this.myArt[b]);var a=new Message();a.module="pica";a.setSpecial("art",this.myArt[b]);a.msg=this.src;window.app.chatapp.fixPrintAndSend(a,true);this.myArt[b]=[]};this.mousemove=function(f,g){if(g===undefined){g=0}if(this.painting&&window.app.chatapp.room!==null){var d=f.pageX-this.offset.left;var c=f.pageY-this.offset.top;var b=parseInt((d/this.width)*this.oWidth);var a=parseInt((c/this.height)*this.oHeight);var i=[];i.push(b);i.push(a);if(g){i.push(this.size);i.push(this.color)}var h=window.app.chatapp.room!==null?window.app.chatapp.room.id:"0";h=h+this.src;this.myArt[h].push(i);this.updateCanvas()}};this.close=function(){this.$window.stop(true,false).fadeOut(200,function(){if(!window.app.ui.pictureui.$window.is(":visible")){window.app.ui.pictureui.$element.removeAttr("src")}if(window.app.ui.pictureui.$canvas!==null){window.app.ui.pictureui.$canvas.remove();window.app.ui.pictureui.$canvas=null}})};this.invalidPicture=function(){this.$element.css("width","").css("height","");this.$element.attr("src",this.link404);this.$element.off("error")};this.streaming=function(a){this.stream=a;if(a){this.$window.css("width","");this.$window.css("right","")}this.handleResize();this.updatePicture()};this.changeSize=function(){this.$currentSize.removeClass("paintIconSmall paintIconMedium paintIconLarge");if(this.size===1){this.size=3;this.$currentSize.addClass("paintIconMedium")}else{if(this.size===3){this.size=6;this.$currentSize.addClass("paintIconLarge")}else{this.size=1;this.$currentSize.addClass("paintIconSmall")}}};this.isLocked=function(){var a=window.app.chatapp.room!==null?window.app.chatapp.room.id:0;return this.locked[a]===true};this.lock=function(b,a){this.locked[b]=a;if(a){this.$lock.addClass("toggled")}else{this.$lock.removeClass("toggled")}}};