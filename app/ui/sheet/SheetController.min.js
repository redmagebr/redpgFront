function SheetController(){this.$listed={};this.currentInstance=0;this.currentStyle=0;this.styles={};this.$list;this.$import;this.$export;this.autoUpdate=false;this.opening=false;this.$cleanhtml=$("<div />");this.$cleancss=$("<style />");this.$html=this.$cleanhtml;this.$css=this.$cleancss;this.init=function(){this.$list=$("#sheetList").empty();this.$import=$("#sheetImportJSON");this.$export=$("#sheetExportJSON");this.$importForm=$("#sheetImportForm");this.$exportForm=$("#sheetExportForm");this.$viewer=$("#sheetViewer");$("#sheetSaveSuccess").hide();$("#sheetSaveError").hide();$("#sheetImportForm").hide();$("#sheetExportForm").hide();this.$closeButton=$("#closeButton");this.$importButton=$("#importButton");this.$saveButton=$("#saveButton");this.$editButton=$("#editButton");this.$exportButton=$("#exportButton");this.$automaticButton=$("#automaticButton");this.$reloadButton=$("#reloadButton");this.$fullReloadButton=$("#fullReloadButton");this.setBindings()};this.setBindings=function(){$("#callSheetWindowBt").on("click",function(){window.app.ui.sheetui.controller.callSelf()});$("#saveButton").on("click",function(){window.app.ui.sheetui.controller.saveSheet()});$("#editButton").on("click",function(){window.app.ui.sheetui.controller.toggleEdit()});$("#importButton").on("click",function(){window.app.ui.sheetui.controller.openImport()});$("#exportButton").on("click",function(){window.app.ui.sheetui.controller.exportSheet()});$("#closeButton").on("click",function(){window.app.ui.sheetui.controller.closeSheet()});$("#sheetImportForm").on("submit",function(){window.app.ui.sheetui.controller.importValues()});$("#reloadButton").on("click",function(){window.app.ui.sheetui.controller.reload(true,false)});$("#automaticButton").on("click",function(){window.app.ui.sheetui.controller.toggleAuto()});$("#fullReloadButton").on("click",function(){window.app.ui.sheetui.controller.reload(true,true)})};this.toggleEdit=function(){this.styles[this.currentStyle].toggleEdit();this.considerEditing()};this.considerEditing=function(){if(this.styles[this.currentStyle].editing){this.$editButton.addClass("toggled")}else{this.$editButton.removeClass("toggled")}};this.callSelf=function(){if(typeof this.$listed[this.currentInstance]==="undefined"){window.app.ui.sheetui.callSelf()}else{window.app.ui.callRightWindow("sheetWindow")}};this.openSheet=function(e,h,l,c,m,i){if(typeof m==="undefined"){m=false}if(typeof c==="undefined"){c=true}if(i===undefined){i=true}if(e===this.currentInstance){window.app.ui.callRightWindow("sheetWindow");return}if(!window.app.sheetdb.isLoaded(e)){window.app.ui.blockRight();var f=window.app.emulateBind(function(){window.app.ui.sheetui.controller.openSheet(this.sheetid,this.styleid,this.gameid,(typeof h==="undefined"),this.dontcallwindow);window.app.ui.unblockRight();window.app.ui.sheetui.controller.$viewer.trigger("loadedSheet",[this.sheetid])},{sheetid:e,styleid:h,gameid:l,dontcallwindow:m});var a=function(){window.app.ui.unblockRight();window.app.ui.callRightWindow("sheetListWindow");window.app.ui.sheetui.$error.show()};window.app.sheetapp.loadSheet(e,f,a)}else{h=window.app.sheetdb.getSheet(e).system;l=window.app.sheetdb.getSheet(e).gameid}if(typeof h==="undefined"){return}if(!window.app.styledb.isLoaded(h)&&c){window.app.ui.blockRight();var f=window.app.emulateBind(function(){window.app.ui.sheetui.controller.openSheet(this.sheetid,this.styleid,this.gameid,false,this.dontcallwindow);window.app.ui.sheetui.controller.$viewer.trigger("loadedStyle",[this.styleid]);window.app.ui.unblockRight()},{sheetid:e,styleid:h,gameid:l,dontcallwindow:m});var a=function(){window.app.ui.unblockRight();window.app.ui.callRightWindow("sheetListWindow");window.app.ui.sheetui.$error.show()};window.app.sheetapp.loadStyle(h,f,a);return}if(!window.app.sheetdb.isLoaded(e)||!window.app.styledb.isLoaded(h)){return}this.$importForm.hide();this.$exportForm.hide();this.$importButton.removeClass("toggled");this.$exportButton.removeClass("toggled");this.opening=true;var g=window.app.sheetdb.getSheet(e).changed;if(typeof this.$listed[e]==="undefined"){this.$listed[e]=$('<a class="toggled" />');this.$listed[e].on("click",window.app.emulateBind(function(){window.app.ui.sheetui.controller.openSheet(this.sheetid,this.styleid)},{sheetid:e,styleid:h}));this.$list.append(this.$listed[e])}else{this.$listed[e].addClass("toggled")}if(typeof this.$listed[this.currentInstance]!=="undefined"){this.$listed[this.currentInstance].removeClass("toggled")}if(i&&e!==this.currentInstance){window.history.pushState({sheetid:e},"",window.location)}var b=this.currentInstance;this.currentInstance=e;if(window.app.sheetdb.getSheet(b)!==null){window.app.sheetdb.getSheet(b).values=this.styles[this.currentStyle].getObject()}if(typeof this.styles[h]==="undefined"){var d=window.app.sheetdb.getSheet(e);var k=window.app.styledb.getStyle(h);this.styles[h]=new Style(d,k);this.styles[h].process();this.styles[h].setValues();if(typeof this.styles[h].nameField!=="undefined"){this.styles[h].nameField.$visible.on("changedVariable",function(){window.app.ui.sheetui.controller.updateCurrentButton()})}if(typeof this.styles[h].mainSheet.fields.Jogador!=="undefined"){this.styles[h].mainSheet.fields.Jogador.$visible.on("changedVariable",function(){window.app.ui.sheetui.controller.updateCurrentButton()})}if(typeof this.styles[h].mainSheet.fields.Player!=="undefined"){this.styles[h].mainSheet.fields.Player.$visible.on("changedVariable",function(){window.app.ui.sheetui.controller.updateCurrentButton()})}this.styles[h].mainSheet.$visible.on("hasChanged",function(){window.app.ui.sheetui.controller.considerChanged()})}else{this.styles[h].switchInstance(window.app.sheetdb.getSheet(e))}if(this.currentStyle!==h){this.$css.detach();this.$html.detach();this.$html=this.styles[h].get$();this.$css=this.styles[h].get$css();this.$viewer.empty().append(this.$html);$("head").append(this.$css);this.currentStyle=h}else{this.currentStyle=h}if(!m){window.app.ui.callRightWindow("sheetWindow",false)}var j=window.app.sheetdb.getSheet(this.currentInstance);j.gameid=l;j.changed=g;if(j.editable){this.$saveButton.show();this.$editButton.show();this.$importButton.show()}else{this.$saveButton.hide();this.$editButton.hide();this.$importButton.hide();if(this.styles[this.currentStyle].editing){this.toggleEdit()}}this.opening=false;this.$reloadButton.show();this.$fullReloadButton.show();this.$automaticButton.show();this.$closeButton.show();this.$exportButton.show();this.considerChanged();this.considerEditing();this.updateCurrentButton()};this.considerChanged=function(){if(this.opening){return}var a=window.app.sheetdb.getSheet(this.currentInstance);if(a.changed){this.$saveButton.addClass("toggled")}else{this.$saveButton.removeClass("toggled")}};this.updateCurrentButton=function(){if(this.opening){return}this.$listed[this.currentInstance].removeClass("character nonplayer");if(typeof this.styles[this.currentStyle]!=="undefined"){var d=this.styles[this.currentStyle];if(typeof d.mainSheet.fields.Jogador!=="undefined"){var c=d.mainSheet.fields.Jogador.getObject()}else{if(typeof d.mainSheet.fields.Player!=="undefined"){var c=d.mainSheet.fields.Player.getObject()}}}else{var b=window.app.sheetdb.getSheet(this.currentInstance);if(typeof b.values.Jogador!=="undefined"){var c=b.values.Jogador}else{if(typeof b.values.Player!=="undefined"){var c=b.values.Player}}}if(c==="NPC"){this.$listed[this.currentInstance].addClass("nonplayer")}else{this.$listed[this.currentInstance].addClass("character")}var a=window.app.sheetdb.getSheet(this.currentInstance).name;if(a.length>10){a=a.split(" ");if(a[0].length>3){a=a[0]}else{a=a[0]+a[1]}if(a.length>10){a=a.substring(0,6)+"..."}}this.$listed[this.currentInstance].text(a)};this.closeSheet=function(){this.$listed[this.currentInstance].remove();delete this.$listed[this.currentInstance];this.$css.detach();this.$html.detach();window.app.sheetdb.deleteSheet(this.currentInstance);this.$viewer.trigger("closedSheet",[this.currentInstance]);this.currentStyle=0;this.currentInstance=0;this.$reloadButton.hide();this.$fullReloadButton.hide();this.$automaticButton.hide();this.$closeButton.hide();this.$exportButton.hide();this.$editButton.hide();this.$importButton.hide();this.$saveButton.hide()};this.importValues=function(){try{var a=JSON.parse(this.$import.val())}catch(d){$("#sheetImportError").show();return}if(typeof a!=="object"){$("#sheetImportError").show();return}var b=window.app.sheetdb.getSheet(this.currentInstance);b.values=a;var c=this.styles[this.currentStyle];c.setValues();$("#sheetImportForm").fadeOut()};this.openImport=function(){$("#sheetExportForm").finish().fadeOut();var a=$("#sheetImportForm");if(a.is(":visible")){a.finish().fadeOut();this.$importButton.removeClass("toggled");return}$("#sheetImportError").hide();this.$import.val("");a.finish().fadeIn();this.$importButton.addClass("toggled");this.$exportButton.removeClass("toggled")};this.exportSheet=function(){$("#sheetImportForm").finish().fadeOut();this.$importButton.removeClass("toggled");var a=$("#sheetExportForm");if(a.is(":visible")){a.finish().fadeOut();this.$exportButton.removeClass("toggled");return}var b=this.styles[this.currentStyle];this.$export.val(JSON.stringify(b.getObject(),undefined,4));a.finish().fadeIn();this.$exportButton.addClass("toggled")};this.saveSheet=function(){window.app.ui.blockRight();var c=function(){$("#sheetSaveSuccess").finish().fadeIn().delay(1500).fadeOut();$("#sheetSaveError").finish().hide();window.app.ui.unblockRight();window.app.ui.sheetui.controller.considerWarning();var g=window.app.sheetdb.getSheet(window.app.ui.sheetui.controller.currentInstance);g.changed=false;window.app.ui.sheetui.controller.considerChanged()};var f=function(){$("#sheetSaveSuccess").finish().hide();$("#sheetSaveError").finish().fadeIn().delay(1500).fadeOut();window.app.ui.unblockRight()};var e=this.styles[this.currentStyle];var a=e.getObject();var d=window.app.sheetdb.getSheet(this.currentInstance);var b=d.name;window.app.sheetapp.sendSheet(this.currentInstance,b,a,c,f)};this.reload=function(b,d){var a=this.currentStyle;var c=this.currentInstance;if(d){var b=window.app.sheetdb.getSheet(this.currentInstance);var d=this.styles[this.currentStyle];b.values=d.getObject();this.$css.detach();this.$html.detach();this.$css=this.$cleancss;this.$html=this.$cleanhtml;d.seppuku();delete this.styles[this.currentStyle];window.app.styledb.deleteStyle(this.currentStyle);this.currentStyle=0}if(b){if(typeof this.$listed[b]!=="undefined"){this.$listed[this.currentInstance].remove();delete this.$listed[b]}window.app.sheetdb.deleteSheet(this.currentInstance);this.currentInstance=0}this.openSheet(c,a,undefined,true,true)};this.updateSpecificSheet=function(c){if(c===this.currentInstance){this.reload(true,false);return}var b=window.app.sheetdb.getSheet(c);if(b===null){return}window.app.ui.blockRight();var a=window.app.emulateBind(function(){if(window.app.ui.sheetui.controller.currentInstance===this.sheetid){window.app.ui.sheetui.reload()}window.app.ui.unblockRight()},{sheetid:c,styleid:b.system});var d=function(){window.app.ui.unblockRight();window.app.ui.callRightWindow("sheetListWindow");window.app.ui.sheetui.$error.show()};window.app.sheetapp.loadSheet(c,a,d)};this.toggleAuto=function(a){if(typeof a==="undefined"){var a=!this.autoUpdate}if(a){$("#automaticButton").addClass("toggled");this.autoUpdate=true}else{this.autoUpdate=false;$("#automaticButton").removeClass("toggled")}};this.considerWarning=function(){if(window.app.ui.chat.cc.room===null){return false}var c=window.app.ui.chat.cc.room;var a=window.app.sheetdb.getSheet(this.currentInstance);if(c.gameid!==a.gameid){return false}var b=new Message();b.setOrigin(window.app.loginapp.user.id);b.roomid=window.app.ui.chat.cc.room.id;b.module="sheetup";b.setSpecial("sheetid",this.currentInstance);window.app.ui.chat.cc.room.addLocal(b);window.app.chatapp.sendMessage(b)}};